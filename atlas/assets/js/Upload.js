import{d as e,u as a,r as l,m as s,a as t,b as o,e as u,j as r,w as i,i as d,o as n,p as c,q as p,k as m,s as v,x as f,y as h,z as _,A as b,E as g,_ as w}from"./index.js";import{a as x,E as y}from"./interceptor.js";const V={class:"upload-wrapper"},U={class:"upload-container"},k={class:"upload-header"},z={class:"upload-title"},E={class:"form-scroll-container"},I={class:"upload-plus"},L=w(e({__name:"Upload",setup(e){const w=a(),L=l({title:"",author:"",description:""}),P=l([]),C=l([]),j=l(!1),A=e=>{const a=e.type.startsWith("image/"),l=e.size/1024/1024<100;return a||g.error("只能上传图片文件!"),l||g.error("文件大小不能超过100MB!"),a&&l},D=l(!1),F=l([]),O=l(0),$=e=>{F.value=P.value.map((e=>e.url||e.response?.url)),O.value=P.value.findIndex((a=>a.uid===e.uid)),D.value=!0},B=(e,a)=>{const l=P.value.findIndex((a=>a.uid===e.uid));if(-1!==l){if(P.value.splice(l,1),e.url){const a=C.value.indexOf(e.url);-1!==a&&C.value.splice(a,1)}g.success("文件删除成功")}else g.warning("文件未找到")},G=async e=>new Promise(((a,l)=>{const s=new FormData;s.append("namespace","blog/atlas"),s.append("file",e.raw),x.post(y.FILE.UPLOAD,s,{headers:{"Content-Type":"multipart/form-data"}}).then((e=>{e.data?.url?a(e.data.url):l(new Error("上传失败，未返回URL"))})).catch((e=>{l(e)}))})),M=async()=>{if(L.value.title&&L.value.author&&L.value.description)if(0!==P.value.length)if(P.value.length>10)g.error("一次性上传文件不能超过十张!");else{j.value=!0;try{const a=[];for(const s of P.value)try{const e=await G(s);a.push(e),s.url=e}catch(e){return g.error(`图片 ${s.name} 上传失败`),console.error("上传出错:",e),void(j.value=!1)}C.value=a;const l={title:L.value.title||"未命名",author:L.value.author||"佚名",description:L.value.description||"无",userId:w.userId||"1000",urls:a};console.log("提交数据:",l),x.post(y.UPLOAD,l).then((e=>{830===e.data.overallStatus?(g.success("提交成功"),q()):(g.error("提交失败"),console.log("提交失败:"+e.data.message),e.data.results&&e.data.results.length>0&&e.data.results.forEach(((e,a)=>{830!==e.status&&console.log(`文件 ${a+1} 上传失败: ${e.message}`)})))})).catch((e=>{g.error("提交出错"),console.error("提交出错:",e.message)})).finally((()=>{j.value=!1}))}catch(e){g.error("上传过程中出错"),console.error("上传过程中出错:",e),j.value=!1}}else g.error("请上传至少一张图片!");else g.error("请填写所有必填项!")},q=()=>{L.value.title="",L.value.author="",L.value.description="",P.value=[],C.value=[]};return s((()=>{const e=document.documentElement.classList;"dark"===w.theme?e.add("dark-theme"):e.remove("dark-theme")})),(e,a)=>{const l=d("el-icon"),s=d("el-upload"),g=d("el-form-item"),w=d("el-input"),x=d("el-button"),y=d("el-form");return n(),t("div",V,[a[10]||(a[10]=o("div",{class:"film-stripe"},null,-1)),o("div",U,[o("div",k,[o("h2",z,[u(l,{size:24,class:"title-icon"},{default:i((()=>[u(c(p))])),_:1}),a[5]||(a[5]=r(" 照片上传 "))])]),o("div",E,[u(y,{ref:"uploadForm",model:L.value,"label-width":"110px",class:"upload-form"},{default:i((()=>[u(g,{label:"选择照片",class:"form-item-photo"},{default:i((()=>[u(s,{"list-type":"picture-card","on-preview":$,"on-remove":B,"file-list":P.value,"onUpdate:fileList":a[0]||(a[0]=e=>P.value=e),"before-upload":A,"auto-upload":!1,class:"photo-uploader"},{default:i((()=>[o("div",I,[u(l,{size:28},{default:i((()=>[u(c(f))])),_:1}),a[6]||(a[6]=o("span",{class:"upload-text"},"添加照片",-1))])])),_:1},8,["file-list"]),D.value?(n(),m(c(h),{key:0,"url-list":F.value,"initial-index":O.value,onClose:a[1]||(a[1]=e=>D.value=!1)},null,8,["url-list","initial-index"])):v("",!0),a[7]||(a[7]=o("p",{class:"upload-hint"},"支持JPG、PNG格式，单张不超过100MB",-1))])),_:1}),u(g,{label:"照片标题",class:"form-item"},{default:i((()=>[u(w,{modelValue:L.value.title,"onUpdate:modelValue":a[2]||(a[2]=e=>L.value.title=e),placeholder:"输入照片标题",class:"custom-input"},null,8,["modelValue"])])),_:1}),u(g,{label:"拍摄作者",class:"form-item"},{default:i((()=>[u(w,{modelValue:L.value.author,"onUpdate:modelValue":a[3]||(a[3]=e=>L.value.author=e),placeholder:"输入作者名称",class:"custom-input"},null,8,["modelValue"])])),_:1}),u(g,{label:"照片描述",class:"form-item"},{default:i((()=>[u(w,{modelValue:L.value.description,"onUpdate:modelValue":a[4]||(a[4]=e=>L.value.description=e),placeholder:"描述照片内容或故事",class:"custom-input",type:"textarea",rows:3},null,8,["modelValue"])])),_:1}),u(g,{class:"form-actions"},{default:i((()=>[u(x,{onClick:M,loading:j.value,class:"submit-btn"},{default:i((()=>[a[8]||(a[8]=r(" 上传图片 ")),u(l,{size:16,class:"btn-icon"},{default:i((()=>[u(c(_))])),_:1})])),_:1},8,["loading"]),u(x,{onClick:q,class:"reset-btn"},{default:i((()=>[a[9]||(a[9]=r(" 重置 ")),u(l,{size:16,class:"btn-icon"},{default:i((()=>[u(c(b))])),_:1})])),_:1})])),_:1})])),_:1},8,["model"])])]),a[11]||(a[11]=o("div",{class:"film-stripe bottom"},null,-1))])}}}),[["__scopeId","data-v-81389e87"]]);export{L as default};
